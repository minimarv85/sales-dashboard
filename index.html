<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Pipeline Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 20px; }
        h1 { margin-bottom: 10px; color: #333; }
        .subtitle { color: #666; margin-bottom: 30px; }
        
        .upload-zone {
            border: 3px dashed #ccc;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            background: white;
            cursor: pointer;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        .upload-zone:hover { border-color: #2563EB; background: #f0f8ff; }
        .upload-zone h2 { margin-bottom: 10px; }
        .upload-zone p { color: #666; }
        
        #file-input { display: none; }
        
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 30px; }
        .stat { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .stat h3 { color: #666; font-size: 14px; margin-bottom: 8px; }
        .stat .value { font-size: 24px; font-weight: bold; color: #333; }
        
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 30px; }
        .chart { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .chart h3 { margin-bottom: 16px; }
        
        .bar-chart { display: flex; flex-direction: column; gap: 8px; }
        .bar-row { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 100px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bar-track { flex: 1; height: 20px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: #2563EB; border-radius: 4px; transition: width 0.3s; }
        .bar-value { width: 80px; text-align: right; font-size: 12px; font-weight: 500; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f8f8; font-size: 12px; color: #666; text-transform: uppercase; }
        
        .status { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .status.live { background: #d1fae5; color: #059669; }
        .status.quotation { background: #dbeafe; color: #2563EB; }
        .status.awaiting { background: #fef3c7; color: #d97706; }
        .status.completed { background: #ede9fe; color: #7c3aed; }
        .status.lost { background: #fee2e2; color: #dc2626; }
        
        .filters { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .filters input, .filters select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .filters input { flex: 1; min-width: 200px; }
        
        .leadgen-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
        .leadgen-card { background: #f8f8f8; padding: 16px; border-radius: 8px; }
        .leadgen-card .name { font-weight: 600; margin-bottom: 4px; }
        .leadgen-card .value { font-size: 20px; font-weight: bold; color: #2563EB; }
        .leadgen-card .stats { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <h1>üìä Sales Pipeline Dashboard</h1>
    <p class="subtitle">Upload your sales CSV to analyze performance</p>
    
    <form id="upload-form">
        <div class="upload-zone" onclick="document.getElementById('file-input').click()">
            <h2>üìÅ Click to Select CSV File</h2>
            <p>or drag and drop file here</p>
        </div>
        <input type="file" id="file-input" name="file" accept=".csv">
    </form>
    
    <div class="dashboard" id="dashboard">
        <div class="stats">
            <div class="stat">
                <h3>Total Pipeline Value</h3>
                <div class="value" id="total-value">¬£0</div>
            </div>
            <div class="stat">
                <h3>Active Opportunities</h3>
                <div class="value" id="active-count">0</div>
            </div>
            <div class="stat">
                <h3>Win Rate</h3>
                <div class="value" id="win-rate">0%</div>
            </div>
            <div class="stat">
                <h3>Avg Deal Size</h3>
                <div class="value" id="avg-deal">¬£0</div>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart">
                <h3>Pipeline by Status</h3>
                <div class="bar-chart" id="status-chart"></div>
            </div>
            <div class="chart">
                <h3>Value by Lead Generator</h3>
                <div class="bar-chart" id="leadgen-chart"></div>
            </div>
        </div>
        
        <div class="chart" style="margin-bottom: 30px;">
            <h3>Lead Generator Performance</h3>
            <div class="leadgen-cards" id="leadgen-cards"></div>
        </div>
        
        <div class="chart">
            <h3>Pipeline Details</h3>
            <div class="filters">
                <input type="text" id="search" placeholder="Search by client or reference...">
                <select id="status-filter">
                    <option value="">All Statuses</option>
                    <option value="Live">Live</option>
                    <option value="Quotation Produced">Quotation Produced</option>
                    <option value="Awaiting Quotation">Awaiting Quotation</option>
                </select>
                <select id="leadgen-filter">
                    <option value="">All Lead Gens</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Reference</th>
                        <th>Client</th>
                        <th>Value</th>
                        <th>Status</th>
                        <th>Lead Gen</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
    
    <script>
        var csvData = [];
        var fileInput = document.getElementById('file-input');
        var dashboard = document.getElementById('dashboard');
        var uploadForm = document.getElementById('upload-form');
        
        // Handle file selection
        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });
        
        // Handle drag and drop
        document.body.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        document.body.addEventListener('drop', function(e) {
            e.preventDefault();
            var file = e.dataTransfer.files[0];
            if (file && file.name.toLowerCase().endsWith('.csv')) {
                processFile(file);
            } else {
                alert('Please drop a CSV file');
            }
        });
        
        function processFile(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var text = e.target.result;
                    var lines = text.trim().split('\n');
                    var headers = lines[0].split(',').map(function(h) { 
                        return h.trim().replace(/^"|"$/g, ''); 
                    });
                    
                    csvData = [];
                    for (var i = 1; i < lines.length; i++) {
                        var values = parseCSVLine(lines[i]);
                        var row = {};
                        for (var j = 0; j < headers.length; j++) {
                            row[headers[j]] = (values[j] || '').trim().replace(/^"|"$/g, '');
                        }
                        if (row.Reference) csvData.push(row);
                    }
                    
                    // Show dashboard
                    uploadForm.style.display = 'none';
                    dashboard.classList.add('active');
                    
                    updateDashboard();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.onerror = function() {
                alert('Error reading file');
            };
            reader.readAsText(file);
        }
        
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }
        
        function updateDashboard() {
            var totalValue = 0;
            var activeCount = 0;
            var completedCount = 0;
            var statusData = {};
            var leadgenData = {};
            
            for (var i = 0; i < csvData.length; i++) {
                var row = csvData[i];
                var value = parseFloat(row['Initial Contract Value'] || '0') || 0;
                var status = row.Status || 'Unknown';
                var lg = row['Lead Generator'] || 'Unknown';
                
                if (value > 0) totalValue += value;
                
                if (status === 'Live' || status === 'Completed') completedCount++;
                if (status !== 'Completed' && status !== 'Client Lost Lead' && status !== 'Lost Lead') activeCount++;
                
                if (!statusData[status]) statusData[status] = 0;
                statusData[status]++;
                
                if (!leadgenData[lg]) leadgenData[lg] = { count: 0, value: 0 };
                leadgenData[lg].count++;
                leadgenData[lg].value += value;
            }
            
            var winRate = activeCount > 0 ? ((completedCount / activeCount) * 100).toFixed(1) : 0;
            var avgDeal = completedCount > 0 ? (totalValue / completedCount) : 0;
            
            document.getElementById('total-value').textContent = '¬£' + Math.round(totalValue).toLocaleString();
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('win-rate').textContent = winRate + '%';
            document.getElementById('avg-deal').textContent = '¬£' + Math.round(avgDeal).toLocaleString();
            
            renderBarChart('status-chart', statusData, false);
            renderBarChart('leadgen-chart', leadgenData, true);
            renderLeadgenCards(leadgenData);
            renderTable(csvData);
            populateLeadgenFilter(leadgenData);
        }
        
        function renderBarChart(containerId, data, isValue) {
            var container = document.getElementById(containerId);
            var entries = Object.keys(data).map(function(k) {
                return { label: k, value: isValue ? data[k].value : data[k] };
            }).sort(function(a, b) { return b.value - a.value; }).slice(0, 8);
            
            var max = entries[0] ? entries[0].value : 1;
            
            container.innerHTML = entries.map(function(e) {
                var percent = (e.value / max * 100).toFixed(0);
                var displayValue = isValue ? '¬£' + Math.round(e.value).toLocaleString() : e.value;
                return '<div class="bar-row">' +
                    '<div class="bar-label" title="' + e.label + '">' + e.label + '</div>' +
                    '<div class="bar-track"><div class="bar-fill" style="width:' + percent + '%"></div></div>' +
                    '<div class="bar-value">' + displayValue + '</div></div>';
            }).join('');
        }
        
        function renderLeadgenCards(data) {
            var container = document.getElementById('leadgen-cards');
            var entries = Object.keys(data).map(function(k) {
                return { name: k, count: data[k].count, value: data[k].value };
            }).sort(function(a, b) { return b.value - a.value; });
            
            container.innerHTML = entries.map(function(e) {
                return '<div class="leadgen-card">' +
                    '<div class="name">' + e.name + '</div>' +
                    '<div class="value">¬£' + Math.round(e.value).toLocaleString() + '</div>' +
                    '<div class="stats">' + e.count + ' opportunities</div></div>';
            }).join('');
        }
        
        function renderTable(data) {
            var tbody = document.getElementById('table-body');
            tbody.innerHTML = data.slice(0, 50).map(function(row) {
                var value = parseFloat(row['Initial Contract Value'] || '0') || 0;
                var statusClass = '';
                var status = row.Status || '';
                if (status.toLowerCase().includes('live')) statusClass = 'live';
                else if (status.toLowerCase().includes('quotation')) statusClass = 'quotation';
                else if (status.toLowerCase().includes('awaiting')) statusClass = 'awaiting';
                else if (status.toLowerCase().includes('completed')) statusClass = 'completed';
                else if (status.toLowerCase().includes('lost') || status.toLowerCase().includes('declined')) statusClass = 'lost';
                
                return '<tr>' +
                    '<td><strong>' + (row.Reference || '') + '</strong></td>' +
                    '<td>' + (row.Client || '') + '</td>' +
                    '<td><strong>' + (value > 0 ? '¬£' + Math.round(value).toLocaleString() : '-') + '</strong></td>' +
                    '<td><span class="status ' + statusClass + '">' + status + '</span></td>' +
                    '<td>' + (row['Lead Generator'] || '') + '</td></tr>';
            }).join('');
        }
        
        function populateLeadgenFilter(data) {
            var select = document.getElementById('leadgen-filter');
            var options = '<option value="">All Lead Gens</option>';
            Object.keys(data).forEach(function(lg) {
                options += '<option value="' + lg + '">' + lg + '</option>';
            });
            select.innerHTML = options;
        }
    </script>
</body>
</html>
