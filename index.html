<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Pipeline Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, sans-serif; background: #f5f5f5; padding: 20px; }
        h1 { margin-bottom: 10px; color: #333; }
        .subtitle { color: #666; margin-bottom: 30px; }
        
        .upload-zone {
            border: 3px dashed #ccc;
            border-radius: 16px;
            padding: 60px;
            text-align: center;
            background: white;
            cursor: pointer;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        .upload-zone:hover { border-color: #2563EB; background: #f0f8ff; }
        .upload-zone h2 { margin-bottom: 10px; }
        .upload-zone p { color: #666; }
        
        #file-input { display: none; }
        
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        
        .header-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 20px;
        }
        
        .btn-reset {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 30px; }
        .stat { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .stat h3 { color: #666; font-size: 14px; margin-bottom: 8px; }
        .stat .value { font-size: 24px; font-weight: bold; color: #333; }
        
        .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 30px; }
        .chart { background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        .chart h3 { margin-bottom: 16px; }
        
        .bar-chart { display: flex; flex-direction: column; gap: 8px; }
        .bar-row { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 100px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .bar-track { flex: 1; height: 20px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .bar-fill { height: 100%; background: #2563EB; border-radius: 4px; transition: width 0.3s; }
        .bar-value { width: 80px; text-align: right; font-size: 12px; font-weight: 500; }
        
        .leadgen-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
        .leadgen-card { background: #f8f8f8; padding: 16px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .leadgen-card:hover { background: #e8e8ff; transform: translateY(-2px); }
        .leadgen-card.selected { background: #dbeafe; border: 2px solid #2563EB; }
        .leadgen-card .name { font-weight: 600; margin-bottom: 4px; }
        .leadgen-card .value { font-size: 20px; font-weight: bold; color: #2563EB; }
        .leadgen-card .stats { font-size: 12px; color: #666; }
        
        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #eee;
            margin-bottom: 30px;
        }
        
        .filters-section h3 { margin-bottom: 16px; }
        
        .filters-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
        .filters-row label { font-size: 14px; color: #666; }
        .filters-row input, .filters-row select {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        .filters-row input[type="date"] { width: 160px; }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .project-card {
            background: white;
            padding: 16px;
            border-radius: 12px;
            border: 1px solid #eee;
            cursor: pointer;
            transition: all 0.2s;
        }
        .project-card:hover { border-color: #2563EB; transform: translateY(-2px); }
        .project-card h4 { margin-bottom: 8px; color: #333; }
        .project-card .client { font-size: 14px; color: #666; margin-bottom: 8px; }
        .project-card .details { display: flex; justify-content: space-between; align-items: center; }
        .project-card .value { font-size: 18px; font-weight: bold; color: #10B981; }
        .project-card .status { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .project-card .status.live { background: #d1fae5; color: #059669; }
        .project-card .status.quotation { background: #dbeafe; color: #2563EB; }
        .project-card .status.awaiting { background: #fef3c7; color: #d97706; }
        .project-card .status.completed { background: #ede9fe; color: #7c3aed; }
        .project-card .status.lost { background: #fee2e2; color: #dc2626; }
        .project-card .date { font-size: 12px; color: #999; }
        
        .load-more {
            display: block;
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }
        .load-more:hover { background: #1D4ED8; }
        .load-more:disabled { background: #ccc; cursor: not-allowed; }
        
        .count-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        
        .no-projects {
            text-align: center;
            padding: 60px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üìä Sales Pipeline Dashboard</h1>
    <p class="subtitle">Upload your sales CSV to analyze performance</p>
    
    <div class="upload-zone" onclick="document.getElementById('file-input').click()">
        <h2>üìÅ Click to Select CSV File</h2>
        <p>or drag and drop file here</p>
    </div>
    <input type="file" id="file-input" accept=".csv">
    
    <div class="dashboard" id="dashboard">
        <div class="header-row">
            <h2>Pipeline Overview</h2>
            <button class="btn-reset" onclick="resetDashboard()">üì§ Upload New File</button>
        </div>
        
        <div class="stats">
            <div class="stat">
                <h3>Total Pipeline Value</h3>
                <div class="value" id="total-value">¬£0</div>
            </div>
            <div class="stat">
                <h3>Live Projects</h3>
                <div class="value" id="active-count">0</div>
            </div>
            <div class="stat">
                <h3>Win Rate</h3>
                <div class="value" id="win-rate">0%</div>
            </div>
            <div class="stat">
                <h3>Total Live Value</h3>
                <div class="value" id="avg-deal">¬£0</div>
            </div>
        </div>
        
        <div class="charts">
            <div class="chart">
                <h3>Pipeline by Status</h3>
                <div class="bar-chart" id="status-chart"></div>
            </div>
            <div class="chart">
                <h3>Value by Lead Generator</h3>
                <div class="bar-chart" id="leadgen-chart"></div>
            </div>
        </div>
        
        <div class="chart" style="margin-bottom: 30px;">
            <h3>Lead Generator Performance (click to filter)</h3>
            <div class="leadgen-cards" id="leadgen-cards"></div>
        </div>
        
        <div class="filters-section">
            <h3>üîç Filter Projects</h3>
            <div class="filters-row">
                <label>Date From:</label>
                <input type="date" id="date-from" onchange="applyFilters()">
                
                <label>Date To:</label>
                <input type="date" id="date-to" onchange="applyFilters()">
                
                <label>Status:</label>
                <select id="status-filter" onchange="applyFilters()">
                    <option value="">All Statuses</option>
                </select>
                
                <label>Lead Gen:</label>
                <select id="leadgen-filter" onchange="applyFilters()">
                    <option value="">All Lead Gens</option>
                </select>
                
                <button onclick="clearFilters()" style="padding: 10px 16px; border: 1px solid #ddd; background: white; border-radius: 8px; cursor: pointer;">Clear</button>
            </div>
        </div>
        
        <p class="count-label" id="count-label">Showing 0 projects</p>
        
        <div class="projects-grid" id="projects-grid"></div>
        
        <button class="load-more" id="load-more" onclick="loadMore()">Load More Projects</button>
    </div>
    
    <script>
        var csvData = [];
        var filteredData = [];
        var displayedCount = 0;
        var pageSize = 10;
        var selectedLeadGen = '';
        
        document.getElementById('file-input').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) processFile(file);
        });
        
        document.body.addEventListener('dragover', function(e) { e.preventDefault(); });
        document.body.addEventListener('drop', function(e) {
            e.preventDefault();
            var file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        
        function processFile(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var text = e.target.result;
                    var lines = text.trim().split('\n');
                    var headers = lines[0].split(',').map(function(h) { 
                        return h.trim().replace(/^"|"$/g, ''); 
                    });
                    
                    csvData = [];
                    for (var i = 1; i < lines.length; i++) {
                        var values = parseCSVLine(lines[i]);
                        var row = {};
                        for (var j = 0; j < headers.length; j++) {
                            row[headers[j]] = (values[j] || '').trim().replace(/^"|"$/g, '');
                        }
                        if (row.Reference) csvData.push(row);
                    }
                    
                    // Sort by date created (newest first) - handle invalid dates
                    csvData.sort(function(a, b) {
                        var dateA = parseDate(a['Date Created']);
                        var dateB = parseDate(b['Date Created']);
                        if (!dateA) dateA = new Date('01/01/1970');
                        if (!dateB) dateB = new Date('01/01/1970');
                        return dateB - dateA;
                    });
                    
                    document.querySelector('.upload-zone').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    
                    updateDashboard();
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };
            reader.readAsText(file);
        }
        
        function parseCSVLine(line) {
            var result = [];
            var current = '';
            var inQuotes = false;
            for (var i = 0; i < line.length; i++) {
                var char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else current += char;
            }
            result.push(current);
            return result;
        }
        
        function parseDate(dateStr) {
            if (!dateStr) return null;
            // Try DD/MM/YYYY format first (UK)
            var parts = dateStr.split('/');
            if (parts.length === 3) {
                var d = new Date(parts[2] + '-' + parts[1] + '-' + parts[0]);
                if (!isNaN(d.getTime())) return d;
            }
            // Try ISO format
            var iso = new Date(dateStr);
            if (!isNaN(iso.getTime())) return iso;
            return null;
        }
        
        function updateDashboard() {
            var totalValue = 0;
            var activeCount = 0;
            var completedCount = 0;
            var statusData = {};
            var leadgenData = {};
            
            csvData.forEach(function(row) {
                var value = parseFloat(row['Initial Contract Value'] || '0') || 0;
                var status = row.Status || 'Unknown';
                var lg = row['Lead Generator'] || 'Unknown';
                
                if (value > 0) totalValue += value;
                if (status === 'Live' || status === 'Completed') completedCount++;
                if (!['Completed', 'Client Lost Lead', 'Lost Lead', 'Declined to Tender', 'Order Cancelled'].includes(status)) activeCount++;
                
                statusData[status] = (statusData[status] || 0) + value;
                if (!leadgenData[lg]) leadgenData[lg] = { count: 0, value: 0 };
                leadgenData[lg].count++;
                leadgenData[lg].value += value;
            });
            
            // Win Rate = Live / Quotes Produced
                var liveCount = csvData.filter(r => (r.Status || '').toLowerCase().includes('live')).length;
                var quoteCount = csvData.filter(r => (r.Status || '').toLowerCase().includes('quotation')).length;
                renderBarChart('status-chart', statusData);
            renderBarChart('leadgen-chart', leadgenData, true);
            renderLeadgenCards(leadgenData);
            populateLeadgenFilter(leadgenData);
            populateStatusFilter();
            applyFilters();
        }
        
        function populateStatusFilter() {
            var select = document.getElementById('status-filter');
            var statusCounts = {};
            csvData.forEach(function(r) {
                var s = (r.Status || '').trim();
                statusCounts[s] = (statusCounts[s] || 0) + 1;
            });
            var statuses = Object.keys(statusCounts).filter(Boolean).sort();
            var options = '<option value="">All Statuses</option>';
            statuses.forEach(function(s) {
                options += '<option data-status="' + s + '">' + s + '</option>';
            });
            select.innerHTML = options;
        }
        
        function renderBarChart(containerId, data, isValue) {
            var container = document.getElementById(containerId);
            var entries = Object.keys(data).map(function(k) {
                return { label: k, value: isValue ? data[k].value : data[k] };
            }).sort(function(a, b) { return b.value - a.value; }).slice(0, 8);
            
            var max = entries[0] ? entries[0].value : 1;
            
            container.innerHTML = entries.map(function(e) {
                var percent = (e.value / max * 100).toFixed(0);
                var displayValue = isValue ? '¬£' + Math.round(e.value).toLocaleString() : e.value;
                return '<div class="bar-row">' +
                    '<div class="bar-label" title="' + e.label + '">' + e.label + '</div>' +
                    '<div class="bar-track"><div class="bar-fill" style="width:' + percent + '%"></div></div>' +
                    '<div class="bar-value">' + displayValue + '</div></div>';
            }).join('');
        }
        
        function renderLeadgenCards(data) {
            var container = document.getElementById('leadgen-cards');
            var entries = Object.keys(data).map(function(k) {
                return { name: k, count: data[k].count, value: data[k].value };
            }).sort(function(a, b) { return b.value - a.value; });
            
            container.innerHTML = entries.map(function(e) {
                var selected = selectedLeadGen === e.name ? 'selected' : '';
                return '<div class="leadgen-card ' + selected + '" onclick="selectLeadGen(\'' + e.name.replace(/'/g, "\\'") + '\')">' +
                    '<div class="name">' + e.name + '</div>' +
                    '<div class="value">¬£' + Math.round(e.value).toLocaleString() + '</div>' +
                    '<div class="stats">' + e.count + ' opportunities</div></div>';
            }).join('');
        }
        
        function selectLeadGen(name) {
            selectedLeadGen = selectedLeadGen === name ? '' : name;
            renderLeadgenCards(getLeadgenData());
            applyFilters();
        }
        
        function getLeadgenData() {
            var leadgenData = {};
            csvData.forEach(function(row) {
                var lg = row['Lead Generator'] || 'Unknown';
                if (!leadgenData[lg]) leadgenData[lg] = { count: 0, value: 0 };
                leadgenData[lg].count++;
                leadgenData[lg].value += parseFloat(row['Initial Contract Value'] || '0') || 0;
            });
            return leadgenData;
        }
        
        function populateLeadgenFilter(data) {
            var select = document.getElementById('leadgen-filter');
            var leadgens = [...new Set(csvData.map(function(r) { return (r['Lead Generator'] || '').trim(); }))].filter(Boolean).sort();
            var options = '<option value="">All Lead Gens</option>';
            leadgens.forEach(function(lg) {
                options += '<option value="' + lg + '">' + lg + '</option>';
            });
            select.innerHTML = options;
        }
        
        
        function getSelectedStatus() {
            var select = document.getElementById('status-filter');
            var option = select.options[select.selectedIndex];
            return option.getAttribute('data-status') || '';
        }
        
                function applyFilters() {
            var dateFrom = document.getElementById('date-from').value;
            var dateTo = document.getElementById('date-to').value;
            var status = getSelectedStatus();
            var leadgen = document.getElementById('leadgen-filter').value;
            
            filteredData = csvData.filter(function(row) {
                var date = row['Date Created'] || '';
                var rowDate = parseDate(date);
                var rowDateStr = rowDate ? rowDate.getFullYear() + '-' + String(rowDate.getMonth() + 1).padStart(2, '0') + '-' + String(rowDate.getDate()).padStart(2, '0') : '';
                var rowStatus = (row.Status || '').toLowerCase().trim();
                var rowLeadgen = (row['Lead Generator'] || '').trim();
                var filterStatus = status.toLowerCase();
                var filterLeadgen = leadgen;
                
                // Date matching - only filter by date if date is set AND record has a date
                var matchDateFrom = !dateFrom || !rowDateStr || rowDateStr >= dateFrom;
                var matchDateTo = !dateTo || !rowDateStr || rowDateStr <= dateTo;
                // Exact match for status filter
                var matchStatus = !status || rowStatus === status.toLowerCase();
                var matchLeadgen = !leadgen || rowLeadgen === filterLeadgen;
                var matchSelectedLeadGen = !selectedLeadGen || rowLeadgen === selectedLeadGen;
                
                return matchDateFrom && matchDateTo && matchStatus && matchLeadgen && matchSelectedLeadGen;
            });
            
            displayedCount = 0;
            
            // Calculate stats based on filtered data
            var totalLiveValue = 0;
            var liveProjectCount = 0;
            var quotationCount = 0;
            var totalPipelineValue = 0;
            filteredData.forEach(function(row) {
                var value = parseFloat(row['Initial Contract Value'] || '0') || 0;
                var rowStatus = (row.Status || '').toLowerCase();
                var rowStatusTrim = rowStatus.trim();
                
                // Total Pipeline Value = sum of ALL projects in filtered data
                if (value > 0) totalPipelineValue += value;
                
                // Total Live Value = sum of LIVE projects ONLY
                if (rowStatusTrim === 'live' && value > 0) {
                    totalLiveValue += value;
                    liveProjectCount++;
                }
                // Quotations count for Win Rate
                if (rowStatusTrim === 'quotation produced') quotationCount++;
            });
            
            // Win Rate = Live / Quotations Produced
            var winRate = quotationCount > 0 ? ((liveProjectCount / quotationCount) * 100).toFixed(1) : 0;
            
            // Total Live Value = sum of all projects (regardless of status) in filtered data
            var totalPipelineValue = 0;
            filteredData.forEach(function(row) {
                var value = parseFloat(row['Initial Contract Value'] || '0') || 0;
                if (value > 0) totalPipelineValue += value;
            });
            
            document.getElementById('total-value').textContent = '¬£' + Math.round(totalPipelineValue).toLocaleString();
            document.getElementById('active-count').textContent = liveProjectCount;
            document.getElementById('win-rate').textContent = winRate + '%';
            document.getElementById('avg-deal').textContent = '¬£' + Math.round(totalLiveValue).toLocaleString();
            
            renderProjects();
        }
        
        function renderProjects() {
            var container = document.getElementById('projects-grid');
            var showCount = Math.min(filteredData.length, displayedCount + pageSize);
            var projects = filteredData.slice(0, showCount);
            
            document.getElementById('count-label').textContent = 'Showing ' + showCount + ' of ' + filteredData.length + ' projects';
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="no-projects">No projects match your filters</div>';
                document.getElementById('load-more').style.display = 'none';
                return;
            }
            
            container.innerHTML = projects.map(function(row) {
                var value = parseFloat(row['Initial Contract Value'] || '0') || 0;
                var statusClass = '';
                var status = (row.Status || '').trim();
                if (status.toLowerCase().includes('live')) statusClass = 'live';
                else if (status.toLowerCase().includes('quotation')) statusClass = 'quotation';
                else if (status.toLowerCase().includes('awaiting')) statusClass = 'awaiting';
                else if (status.toLowerCase().includes('completed')) statusClass = 'completed';
                else if (status.toLowerCase().includes('lost') || status.toLowerCase().includes('declined')) statusClass = 'lost';
                
                return '<div class="project-card">' +
                    '<h4>' + (row.Reference || '') + '</h4>' +
                    '<div class="client">' + (row.Client || '') + '</div><div class="address" style="font-size: 12px; color: #888; margin-top: 4px;">' + (row['Address Title'] || '') + '</div>' +
                    '<div class="details">' +
                        '<span class="value">' + (value > 0 ? '¬£' + Math.round(value).toLocaleString() : '-') + '</span>' +
                        '<span class="status ' + statusClass + '">' + status + '</span>' +
                    '</div>' +
                    '<div class="date" style="margin-top: 8px;">Created: ' + (row['Date Created'] || '') + '</div>' +
                '</div>';
            }).join('');
            
            document.getElementById('load-more').style.display = showCount < filteredData.length ? 'block' : 'none';
        }
        
        function loadMore() {
            displayedCount += pageSize;
            renderProjects();
        }
        
        function clearFilters() {
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('status-filter').value = '';
            document.getElementById('leadgen-filter').value = '';
            selectedLeadGen = '';
            renderLeadgenCards(getLeadgenData());
            applyFilters();
        }
        
        function resetDashboard() {
            csvData = [];
            filteredData = [];
            displayedCount = 0;
            selectedLeadGen = '';
            document.querySelector('.upload-zone').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('file-input').value = '';
        }
    </script>
</body>
</html>
